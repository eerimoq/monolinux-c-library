/*
 * The MIT License (MIT)
 *
 * Copyright (c) 2019, Erik Moqvist
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use, copy,
 * modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
 * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
 * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * This file is part of the Monolinux C library project.
 */

#include <sys/types.h>
#include <sys/socket.h>
#include <sys/timerfd.h>
#include <netinet/if_ether.h>
#include <linux/if_packet.h>
#include "nala.h"
#include "nala_mocks.h"
#include "ml/ml.h"
#include "utils/utils.h"
#include "utils/mocks/mock_libc.h"
#include "utils/mocks/mock.h"

/* File descriptors. */
#define SOCK_FD          11
#define SOCK_PACKET_FD   11
#define SOCK_UDP_FD      11
#define RENEW_FD         12
#define REBIND_FD        13
#define RESP_FD          14
#define INIT_FD          15

#define SOCK_IX   0
#define RENEW_IX  1
#define REBIND_IX 2
#define RESP_IX   3
#define INIT_IX   4

static uint8_t discover[604] = {
   0x45, 0x00, 0x02, 0x5c, 0x00, 0x11, 0x00, 0x00, 0xff, 0x11, 0xb9, 0x80,
   0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x44, 0x00, 0x43,
   0x02, 0x48, 0x00, 0x00, 0x01, 0x01, 0x06, 0x00, 0x32, 0x49, 0x36, 0x78,
   0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04,
   0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x63, 0x82, 0x53, 0x63, 0x35, 0x01, 0x01, 0x39, 0x02, 0x04, 0x00, 0x37,
   0x03, 0x01, 0x06, 0x03, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00
};

static uint8_t offer[1024] = {
    0x45, 0x00, 0x02, 0x5c, 0x00, 0x11, 0x00, 0x00, 0xff, 0x11, 0xb9, 0x80,
    0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x43, 0x00, 0x44,
    0x02, 0x48, 0x00, 0x00,
    0x02, 0x01, 0x06, 0x00, 0x32, 0x49, 0x36, 0x78, 0x00, 0x00, 0x80, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xc0, 0xa8, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x82, 0x53, 0x63,
    0x35, 0x01, 0x02, 0x36, 0x04, 0xc0, 0xa8, 0x00, 0x01, 0x33, 0x04, 0x00,
    0x00, 0x00, 0x3c, 0x3a, 0x04, 0x00, 0x00, 0x00, 0x1e, 0x3b, 0x04, 0x00,
    0x00, 0x00, 0x34, 0x01, 0x04, 0xff, 0xff, 0xff, 0x00, 0x03, 0x04, 0xc0,
    0xa8, 0x00, 0x01, 0x06, 0x08, 0xc0, 0xa8, 0x00, 0x01, 0xc0, 0xa8, 0x01,
    0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static uint8_t request[604]= {
    0x45, 0x00, 0x02, 0x5c, 0x00, 0x11, 0x00, 0x00, 0xff, 0x11, 0xb9, 0x80,
    0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x44, 0x00, 0x43,
    0x02, 0x48, 0x00, 0x00, 0x01, 0x01, 0x06, 0x00, 0x32, 0x49, 0x36, 0x78,
    0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04,
    0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x63, 0x82, 0x53, 0x63, 0x35, 0x01, 0x03, 0x36, 0x04, 0xc0, 0xa8, 0x00,
    0x01, 0x32, 0x04, 0xc0, 0xa8, 0x00, 0x03, 0x33, 0x04, 0x00, 0x00, 0x00,
    0x3c, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static uint8_t request_udp[576]= {
    0x01, 0x01, 0x06, 0x00, 0x32, 0x49, 0x36, 0x78,
    0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04,
    0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x63, 0x82, 0x53, 0x63, 0x35, 0x01, 0x03, 0x36, 0x04, 0xc0, 0xa8, 0x00,
    0x01, 0x32, 0x04, 0xc0, 0xa8, 0x00, 0x03, 0x33, 0x04, 0x00, 0x00, 0x00,
    0x3c, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static uint8_t ack[1024] = {
    0x45, 0x00, 0x02, 0x5c, 0x00, 0x11, 0x00, 0x00, 0xff, 0x11, 0xb9, 0x80,
    0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x43, 0x00, 0x44,
    0x02, 0x48, 0x00, 0x00,
    0x02, 0x01, 0x06, 0x00, 0x32, 0x49, 0x36, 0x78, 0x00, 0x00, 0x80, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xc0, 0xa8, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x82, 0x53, 0x63,
    0x35, 0x01, 0x05, 0x36, 0x04, 0xc0, 0xa8, 0x00, 0x01, 0x33, 0x04, 0x00,
    0x00, 0x00, 0x3c, 0x3a, 0x04, 0x00, 0x00, 0x00, 0x1e, 0x3b, 0x04, 0x00,
    0x00, 0x00, 0x34, 0x0c, 0x02, 0x52, 0x30, 0x01, 0x04, 0xff, 0xff, 0xff,
    0x00, 0x03, 0x04, 0xc0, 0xa8, 0x00, 0x01, 0x06, 0x08, 0xc0, 0xa8, 0x00,
    0x01, 0xc0, 0xa8, 0x01, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static uint8_t ack_udp[1024] = {
    0x02, 0x01, 0x06, 0x00, 0x32, 0x49, 0x36, 0x78, 0x00, 0x00, 0x80, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xc0, 0xa8, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x82, 0x53, 0x63,
    0x35, 0x01, 0x05, 0x36, 0x04, 0xc0, 0xa8, 0x00, 0x01, 0x33, 0x04, 0x00,
    0x00, 0x00, 0x3c, 0x3a, 0x04, 0x00, 0x00, 0x00, 0x1e, 0x3b, 0x04, 0x00,
    0x00, 0x00, 0x34, 0x0c, 0x02, 0x52, 0x30, 0x01, 0x04, 0xff, 0xff, 0xff,
    0x00, 0x03, 0x04, 0xc0, 0xa8, 0x00, 0x01, 0x06, 0x08, 0xc0, 0xa8, 0x00,
    0x01, 0xc0, 0xa8, 0x01, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static uint8_t nak[1024] = {
    0x45, 0x00, 0x02, 0x5c, 0x00, 0x11, 0x00, 0x00, 0xff, 0x11, 0xb9, 0x80,
    0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x43, 0x00, 0x44,
    0x02, 0x48, 0x00, 0x00,
    0x02, 0x01, 0x06, 0x00, 0x32, 0x49, 0x36, 0x78, 0x00, 0x00, 0x80, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xc0, 0xa8, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x82, 0x53, 0x63,
    0x35, 0x01, 0x06, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static uint8_t nak_udp[1024] = {
    0x02, 0x01, 0x06, 0x00, 0x32, 0x49, 0x36, 0x78, 0x00, 0x00, 0x80, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xc0, 0xa8, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x82, 0x53, 0x63,
    0x35, 0x01, 0x06, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static void __fds_in_assert(struct pollfd *__fds,
                            const void *buf_p,
                            size_t size)
{
    const struct pollfd *expected_p;
    size_t i;

    expected_p = buf_p;

    for (i = 0; i < (size / sizeof(*__fds)); i++) {
        ASSERT_EQ(__fds[i].fd, expected_p[i].fd);
        ASSERT_EQ(__fds[i].events, expected_p[i].events);
        /* revents are out parameter. */
    }
}

static void init_pollfds(struct pollfd *fds_p)
{
    memset(fds_p, 0, sizeof(*fds_p) * 5);
    fds_p[SOCK_IX].fd = SOCK_FD;
    fds_p[SOCK_IX].events = POLLIN;
    fds_p[RENEW_IX].fd = RENEW_FD;
    fds_p[RENEW_IX].events = POLLIN;
    fds_p[REBIND_IX].fd = REBIND_FD;
    fds_p[REBIND_IX].events = POLLIN;
    fds_p[RESP_IX].fd = RESP_FD;
    fds_p[RESP_IX].events = POLLIN;
    fds_p[INIT_IX].fd = INIT_FD;
    fds_p[INIT_IX].events = POLLIN;
}

static void mock_push_poll_fd(int index)
{
    struct pollfd fds[5];

    init_pollfds(&fds[0]);
    poll_mock_once(5, -1, 1);
    poll_mock_set___fds_in(&fds[0], sizeof(fds));
    poll_mock_set___fds_in_assert(__fds_in_assert);
    fds[index].revents = POLLIN;
    poll_mock_set___fds_out(&fds[0], sizeof(fds));
}

static void mock_push_setup_packet_socket()
{
    struct sockaddr_ll addr;
    int yes;

    socket_mock_once(AF_PACKET, SOCK_DGRAM, 0, SOCK_PACKET_FD);
    memset(&addr, 0, sizeof(addr));
    addr.sll_family = AF_PACKET;
    addr.sll_protocol = htons(ETH_P_IP);
    addr.sll_ifindex = 5;
    bind_mock_once(SOCK_PACKET_FD, sizeof(addr), 0);
    bind_mock_set___addr_in(&addr, sizeof(addr));
    yes = 1;
    setsockopt_mock_once(SOCK_PACKET_FD,
                         SOL_SOCKET,
                         SO_BROADCAST,
                         sizeof(yes),
                         0);
    setsockopt_mock_set___optval_in(&yes, sizeof(yes));
}

static void mock_push_setup_udp_socket()
{
    struct sockaddr_in addr;

    socket_mock_once(AF_INET, SOCK_DGRAM, 0, SOCK_UDP_FD);
    memset(&addr, 0, sizeof(addr));
    addr.sin_family = AF_INET;
    addr.sin_port = htons(68);
    addr.sin_addr.s_addr = INADDR_ANY;
    bind_mock_once(SOCK_FD, sizeof(addr), 0);
    bind_mock_set___addr_in(&addr, sizeof(addr));
}

static void mock_push_packet_sendto(const uint8_t *buf_p, size_t size)
{
    struct sockaddr_ll addr;

    memset(&addr, 0, sizeof(addr));
    addr.sll_family = AF_PACKET;
    addr.sll_protocol = htons(ETH_P_IP);
    addr.sll_ifindex = 5;
    addr.sll_halen = 6;
    memset(&addr.sll_addr[0], 0xff, addr.sll_halen);
    sendto_mock_once(SOCK_FD, size, 0, sizeof(addr), size);
    sendto_mock_set___buf_in(buf_p, size);
    sendto_mock_set___addr_in((struct sockaddr *)&addr, sizeof(addr));
}

static void mock_push_udp_sendto(const uint8_t *buf_p, size_t size)
{
    struct sockaddr_in addr;

    memset(&addr, 0, sizeof(addr));
    addr.sin_family = AF_INET;
    addr.sin_addr.s_addr = htonl(0xc0a80001);
    addr.sin_port = htons(67);
    sendto_mock_once(SOCK_FD, size, 0, sizeof(addr), size);
    sendto_mock_set___buf_in(buf_p, size);
    sendto_mock_set___addr_in((struct sockaddr *)&addr, sizeof(addr));
}

static void mock_push_dhcp_read(uint8_t *buf_p, size_t size)
{
    ml_read_mock_once(SOCK_FD, 1024, size);
    ml_read_mock_set_buf_p_out(buf_p, 1024);
}

static void mock_push_timer_read(int fd)
{
    uint64_t value;

    value = 0;
    ml_read_mock_once(fd, sizeof(value), sizeof(value));
    ml_read_mock_set_buf_p_out(&value, sizeof(value));
}

static void mock_push_ml_dhcp_client_start(void)
{
    struct itimerspec timeout;
    int interface_index;
    uint8_t mac_address[] = { 0x01, 0x02, 0x03, 0x04, 0x05, 0x06 };

    interface_index = 5;
    ml_network_interface_index_mock_once("eth0", 0);
    ml_network_interface_index_mock_set_index_p_out(&interface_index,
                                                    sizeof(interface_index));
    ml_network_interface_mac_address_mock_once("eth0", 0);
    ml_network_interface_mac_address_mock_set_mac_address_p_out(
        &mac_address[0],
        sizeof(mac_address));
    mock_push_setup_packet_socket();
    timerfd_create_mock_once(CLOCK_REALTIME, 0, RENEW_FD);
    timerfd_create_mock_once(CLOCK_REALTIME, 0, REBIND_FD);
    timerfd_create_mock_once(CLOCK_REALTIME, 0, RESP_FD);
    timerfd_create_mock_once(CLOCK_REALTIME, 0, INIT_FD);
    memset(&timeout, 0, sizeof(timeout));
    timeout.it_value.tv_sec = 0;
    timeout.it_value.tv_nsec = 1;
    timerfd_settime_mock_once(INIT_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
}

static void mock_push_init_to_selecting(void)
{
    struct itimerspec timeout;

    mock_push_poll_fd(INIT_IX);
    mock_push_timer_read(INIT_FD);
    mock_push_packet_sendto(&discover[0], sizeof(discover));
    memset(&timeout, 0, sizeof(timeout));
    timeout.it_value.tv_sec = 5;
    timerfd_settime_mock_once(RESP_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
}

static void mock_push_selecting_to_requesting(void)
{
    struct itimerspec timeout;

    mock_push_poll_fd(SOCK_IX);
    mock_push_dhcp_read(&offer[0], sizeof(offer));
    mock_push_packet_sendto(&request[0], sizeof(request));
    memset(&timeout, 0, sizeof(timeout));
    timeout.it_value.tv_sec = 5;
    timerfd_settime_mock_once(RESP_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
}

static void mock_push_requesting_to_bound(void)
{
    struct itimerspec timeout;

    mock_push_poll_fd(SOCK_IX);
    mock_push_dhcp_read(&ack[0], sizeof(ack));
    memset(&timeout, 0, sizeof(timeout));
    timeout.it_value.tv_sec = 0;
    timerfd_settime_mock_once(RESP_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
    timeout.it_value.tv_sec = 30;
    timerfd_settime_mock_once(RENEW_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
    timeout.it_value.tv_sec = 40;
    timerfd_settime_mock_once(REBIND_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
    ml_network_interface_configure_mock_once("eth0",
                                             "192.168.0.3",
                                             "255.255.255.0",
                                             0);
    ml_network_interface_add_route_mock_once("eth0",
                                             "192.168.0.1",
                                             0);
    ml_close_mock_once(SOCK_PACKET_FD, 0);
    mock_push_setup_udp_socket();
}

static void mock_push_bound_to_renewing(void)
{
    struct itimerspec timeout;

    mock_push_poll_fd(RENEW_IX);
    mock_push_timer_read(RENEW_FD);
    mock_push_udp_sendto(&request_udp[0], sizeof(request_udp));
    memset(&timeout, 0, sizeof(timeout));
    timeout.it_value.tv_sec = 5;
    timerfd_settime_mock_once(RESP_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
}

static void mock_push_renewing_to_bound(void)
{
    struct itimerspec timeout;

    mock_push_poll_fd(SOCK_IX);
    mock_push_dhcp_read(&ack_udp[0], sizeof(ack_udp));
    memset(&timeout, 0, sizeof(timeout));
    timeout.it_value.tv_sec = 0;
    timerfd_settime_mock_once(RESP_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
    timeout.it_value.tv_sec = 30;
    timerfd_settime_mock_once(RENEW_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
    timeout.it_value.tv_sec = 40;
    timerfd_settime_mock_once(REBIND_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
    ml_network_interface_configure_mock_once("eth0",
                                             "192.168.0.3",
                                             "255.255.255.0",
                                             0);
    ml_network_interface_add_route_mock_once("eth0",
                                             "192.168.0.1",
                                             0);
    ml_close_mock_once(SOCK_PACKET_FD, 0);
    mock_push_setup_udp_socket();
}

static void mock_push_enter_init(void)
{
    struct itimerspec timeout;

    memset(&timeout, 0, sizeof(timeout));
    timeout.it_value.tv_sec = 0;
    timerfd_settime_mock_once(RESP_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
    timeout.it_value.tv_sec = 0;
    timerfd_settime_mock_once(REBIND_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
    timeout.it_value.tv_sec = 10;
    timerfd_settime_mock_once(INIT_FD, 0, 0);
    timerfd_settime_mock_set___utmr_in(&timeout, sizeof(timeout));
    ml_close_mock_once(SOCK_FD, 0);
    mock_push_setup_packet_socket();
}

static void mock_push_poll_failure(void)
{
    struct pollfd fds[5];

    init_pollfds(&fds[0]);
    poll_mock_once(5, -1, -1);
    poll_mock_set___fds_in(&fds[0], sizeof(fds));
    poll_mock_set___fds_in_assert(__fds_in_assert);
    poll_mock_set___fds_out(&fds[0], sizeof(fds));
}

TEST(start_join)
{
    struct ml_dhcp_client_t client;

    mock_push_ml_dhcp_client_start();
    mock_push_poll_failure();

    ml_dhcp_client_init(&client, "eth0", ML_LOG_ALL);
    ml_dhcp_client_start(&client);
    ml_dhcp_client_join(&client);
}

TEST(start_failure_last_init_step)
{
    struct ml_dhcp_client_t client;
    struct sockaddr_ll addr;
    int yes;
    int interface_index;
    uint8_t mac_address[] = { 0x01, 0x02, 0x03, 0x04, 0x05, 0x06 };

    interface_index = 5;
    ml_network_interface_index_mock_once("eth0", 0);
    ml_network_interface_index_mock_set_index_p_out(&interface_index,
                                                    sizeof(interface_index));
    ml_network_interface_mac_address_mock_once("eth0", 0);
    ml_network_interface_mac_address_mock_set_mac_address_p_out(
        &mac_address[0],
        sizeof(mac_address));
    socket_mock_once(AF_PACKET, SOCK_DGRAM, 0, SOCK_FD);
    memset(&addr, 0, sizeof(addr));
    addr.sll_family = AF_PACKET;
    addr.sll_protocol = htons(ETH_P_IP);
    addr.sll_ifindex = interface_index;
    bind_mock_once(SOCK_FD, sizeof(addr), 0);
    bind_mock_set___addr_in(&addr, sizeof(addr));
    yes = 1;
    setsockopt_mock_once(SOCK_FD,
                         SOL_SOCKET,
                         SO_BROADCAST,
                         sizeof(yes),
                         0);
    setsockopt_mock_set___optval_in(&yes, sizeof(yes));
    timerfd_create_mock_once(CLOCK_REALTIME, 0, RENEW_FD);
    timerfd_create_mock_once(CLOCK_REALTIME, 0, REBIND_FD);
    timerfd_create_mock_once(CLOCK_REALTIME, 0, RESP_FD);
    timerfd_create_mock_once(CLOCK_REALTIME, 0, -1);
    ml_close_mock_once(RESP_FD, 0);
    ml_close_mock_once(REBIND_FD, 0);
    ml_close_mock_once(RENEW_FD, 0);
    ml_close_mock_once(SOCK_FD, 0);

    ml_dhcp_client_init(&client, "eth0", ML_LOG_ALL);
    ml_dhcp_client_start(&client);
}

TEST(new)
{
    struct ml_dhcp_client_t client;

    mock_push_ml_dhcp_client_start();
    mock_push_init_to_selecting();
    mock_push_selecting_to_requesting();
    mock_push_requesting_to_bound();
    mock_push_poll_failure();

    ml_dhcp_client_init(&client, "eth0", ML_LOG_ALL);
    ml_dhcp_client_start(&client);
    ml_dhcp_client_join(&client);
}

TEST(renew)
{
    struct ml_dhcp_client_t client;

    mock_push_ml_dhcp_client_start();
    mock_push_init_to_selecting();
    mock_push_selecting_to_requesting();
    mock_push_requesting_to_bound();
    mock_push_bound_to_renewing();
    mock_push_renewing_to_bound();
    mock_push_poll_failure();

    ml_dhcp_client_init(&client, "eth0", ML_LOG_ALL);
    ml_dhcp_client_start(&client);
    ml_dhcp_client_join(&client);
}

TEST(renew_nack)
{
    struct ml_dhcp_client_t client;

    mock_push_ml_dhcp_client_start();
    mock_push_init_to_selecting();
    mock_push_selecting_to_requesting();
    mock_push_requesting_to_bound();
    mock_push_bound_to_renewing();
    mock_push_poll_fd(SOCK_IX);
    mock_push_dhcp_read(&nak_udp[0], sizeof(nak_udp));
    mock_push_enter_init();
    mock_push_poll_failure();

    ml_dhcp_client_init(&client, "eth0", ML_LOG_ALL);
    ml_dhcp_client_start(&client);
    ml_dhcp_client_join(&client);
}

TEST(renew_response_timeout)
{
    struct ml_dhcp_client_t client;

    mock_push_ml_dhcp_client_start();
    mock_push_init_to_selecting();
    mock_push_selecting_to_requesting();
    mock_push_requesting_to_bound();
    mock_push_bound_to_renewing();
    mock_push_poll_fd(RESP_IX);
    mock_push_timer_read(RESP_FD);
    mock_push_enter_init();
    mock_push_poll_failure();

    ml_dhcp_client_init(&client, "eth0", ML_LOG_ALL);
    ml_dhcp_client_start(&client);
    ml_dhcp_client_join(&client);
}

TEST(rebind_timeout)
{
    struct ml_dhcp_client_t client;

    mock_push_ml_dhcp_client_start();
    mock_push_init_to_selecting();
    mock_push_selecting_to_requesting();
    mock_push_requesting_to_bound();
    mock_push_bound_to_renewing();
    mock_push_poll_fd(REBIND_IX);
    mock_push_timer_read(REBIND_FD);
    mock_push_enter_init();
    mock_push_poll_failure();

    ml_dhcp_client_init(&client, "eth0", ML_LOG_ALL);
    ml_dhcp_client_start(&client);
    ml_dhcp_client_join(&client);
}

TEST(discovery_response_timeout)
{
    struct ml_dhcp_client_t client;

    mock_push_ml_dhcp_client_start();
    mock_push_init_to_selecting();
    mock_push_poll_fd(RESP_IX);
    mock_push_timer_read(RESP_FD);
    mock_push_enter_init();
    mock_push_poll_failure();

    ml_dhcp_client_init(&client, "eth0", ML_LOG_ALL);
    ml_dhcp_client_start(&client);
    ml_dhcp_client_join(&client);
}

TEST(request_response_timeout)
{
}

TEST(discard_offers_in_requesting)
{
    struct ml_dhcp_client_t client;

    ml_init();

    mock_push_ml_dhcp_client_start();
    mock_push_init_to_selecting();
    mock_push_selecting_to_requesting();
    mock_push_poll_fd(SOCK_IX);
    mock_push_dhcp_read(&offer[0], sizeof(offer));
    mock_push_requesting_to_bound();
    mock_push_poll_failure();

    ml_dhcp_client_init(&client, "eth0", ML_LOG_ALL);
    ml_dhcp_client_start(&client);
    ml_dhcp_client_join(&client);
}

TEST(request_nack)
{
    struct ml_dhcp_client_t client;

    ml_init();

    mock_push_ml_dhcp_client_start();
    mock_push_init_to_selecting();
    mock_push_selecting_to_requesting();
    mock_push_poll_fd(SOCK_IX);
    mock_push_dhcp_read(&nak[0], sizeof(nak));
    mock_push_enter_init();
    mock_push_poll_failure();

    ml_dhcp_client_init(&client, "eth0", ML_LOG_ALL);
    ml_dhcp_client_start(&client);
    ml_dhcp_client_join(&client);
}

void __wrap_ml_timer_handler_init(struct ml_timer_handler_t *self_p)
{
    (void)self_p;
}
